\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, amsfonts, amsthm}
\usepackage{eqproof}

\usepackage{tikz-cd}

\theoremstyle{plain}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}[theorem]{Proposition}
\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}
\newtheorem{counter}[theorem]{Counterexample}
\theoremstyle{remark}
\newtheorem{remark}[theorem]{Remark}
\numberwithin{theorem}{section}

\title{EF-Note}
\author{Dan Marsden}

\begin{document}

\maketitle

\section{Introduction}
This note looks at a few candidate schemes for eliminating the need for I-morphisms by adjusting the comonad~$\mathbb{E}_k$.

Some repeating notation:
\begin{itemize}
    \item $\epsilon$ will always be the function taking the tail element of a list.
    \item $L_k$ will denote the~$k$-bounded list functor on sets and functions, and~$L^+_k$ its non-empty counterpart.
    \item $P_\omega$ will denote the finite covariant powerset functor, and~$\eta$ the associated singleton natural transformation.
    \item We will treat lists as cons lists when convenient, and write~$x:xs$ for list~$xs$ with element~$x$ added at the head.
    \item We will also treat lists as snoc lists when convenient, and write~$xs:x$ for list~$xs$ with element~$x$ added at the tail.
\end{itemize}
To simplify notation, we shall occasionally implicitly overload functions so that they can be applied element wise to tuples of values.

\section{The Naive Scheme}
\label{sec:naive}
In the naive scheme, we restrict our functor to non-repeating sequences. We will need to normalize sequences after the functor action. The simple suggestion is to use the following function:
\begin{definition}
We define inductively a family of functions on lists over a set~$X$, indexed by finite subsets of~$X$
\begin{align*}
    s^X [] &= []\\
    s^X (x:xs) &=
    \begin{cases}
    s^X xs &\mbox{if} x \in X\\
    x : s^{X \cup \{ x \}} xs &\mbox{otherwise}
    \end{cases}
\end{align*}

\end{definition}
We define the structure for our proposed endofunctor.
\begin{definition}
For $\sigma$-structure~$A$, define~$\mathbb{E}^*_K$ as having:
\begin{description}
\item[Universe] The universe is the set of non-repeating, non-empty lists of elements from~$A$.
\item[Relations] For n-tuple $\overline{a}$ of elements, and n-ary relation symbol~$R$, we define:
\begin{equation*}
    R^{\mathbb{E}^*_k}(\overline{a})
\end{equation*}
if the elements of~$\overline{a}$ are pairwise comparable in the prefix order, and:
\begin{equation*}
    R^A(\epsilon(\overline{a}))
\end{equation*}
\end{description}
For homomorphism~$h : A \rightarrow B$ we define function:
\begin{equation*}
    \mathbb{E}^*_k(h) = s^\emptyset \circ L^+_k h
\end{equation*}
\end{definition}
This scheme is unfortunately flawed as we observe:
\begin{lemma}
Even at the level of underlying sets, the following diagram does not in general commute:
\begin{equation*}
\begin{tikzcd}
\mathbb{E}^*_k A \ar[r, "\epsilon"] \ar[d, "\mathbb{E}^*_k h"] & A \ar[d, "h"]\\
\mathbb{E}^*_k B \ar[r, "\epsilon"] &  B
\end{tikzcd}
\end{equation*}
\begin{proof}
We consider list~$[a,b,c]$ and mapping:
\begin{align*}
    h(a) &= a\\
    h(b) &= b\\
    h(c) &= a
\end{align*}
Then chasing around the top leads to~$a$. On the other hand, chasing along the bottom leads to~$b$. The essential problem is that~$s^\emptyset$ does not preserve the last element of lists, so normalization breaks things.
\end{proof}

\end{lemma}

\section{Ad-hoc Normalization Scheme}
This scheme is a rather ad-hoc attempt to patch up the deficiency in the plan of section~\ref{sec:naive}. The intuition is to:
\begin{enumerate}
    \item Remove duplicate elements from lists as in section~\ref{sec:naive}.
    \item Ensure that the final element is preserved by truncating back to the ``original final element''.
\end{enumerate}
Although the original problem seems to go away, this plan sounds like it will lead to whack-a-mole quite quickly, so maybe optimism shouldn't be too high.

To formalize things, we define another auxiliary function:
\begin{definition}
For lists over a set~$X$, and~$x \in X$ we define the following function:
\begin{align*}
    t^x [] &= []\\
    t^x (ys:y) &=
    \begin{cases}
    t^x ys &\mbox{if } x \neq y\\
    (ys:y) &\mbox{otherwise}
    \end{cases}
\end{align*}
\end{definition}
we the define our putative functor as follows:
\begin{definition}
For $\sigma$-structure~$A$, define~$\mathbb{E}^*_K$ as having:
\begin{description}
\item[Universe] The universe is the set of non-repeating, non-empty lists of elements from~$A$.
\item[Relations] For n-tuple $\overline{a}$ of elements, and n-ary relation symbol~$R$, we define:
\begin{equation*}
    R^{\mathbb{E}^*_k}(\overline{a})
\end{equation*}
if the elements of~$\overline{a}$ are pairwise comparable in the prefix order, and:
\begin{equation*}
    R^A(\epsilon(\overline{a}))
\end{equation*}
\end{description}
For homomorphism~$h : A \rightarrow B$ we define function:
\begin{equation*}
    \mathbb{E}^*_k(h)(xs:x) = t^{h x}(s^\emptyset \circ L^+_k h (xs:x))
\end{equation*}
\end{definition}
We need a few technical lemmas to proceed.
\begin{lemma}
\label{lem:t-idem}
Truncation satisfies the following generalized idempotence property:
\begin{equation*}
t^{h a} \circ L^+_k h \circ t^a = t^{h a} \circ L^+_k h
\end{equation*}
\end{lemma}
\begin{lemma}
\label{lem:s-idem}
Shrinking satisfies the following generalized idempotence property:
\begin{equation*}
    s^\emptyset \circ L^+_k h \circ s^\emptyset = s^\emptyset \circ L^+_k h
\end{equation*}
\end{lemma}
\begin{lemma}
\label{lem:t-s-commute}
Truncation and shrinking commute:
\begin{equation*}
    s^\emptyset \circ t^a = t^a \circ s^\emptyset
\end{equation*}
\end{lemma}
\begin{lemma}
Shrinking is monotone with respect to prefix ordering:
\begin{equation*}
    x \leq y \Rightarrow s^\emptyset x \leq s^\emptyset y
\end{equation*}
\end{lemma}
\begin{lemma}
Truncation preserves comparability in the prefix order:
\begin{equation*}
    x \uparrow y \Rightarrow t^a x \uparrow t^a y
\end{equation*}
\end{lemma}
With these in place, we can now look at the action on morphisms of~$\mathbb{E}^*_k$.
\begin{lemma}
For $\sigma$-structure homomorphism~$h : A \rightarrow B$, $\mathbb{E}^*_k h$ is a homomorphism of type:
\begin{equation*}
    \mathbb{E}^*_k A \rightarrow \mathbb{E}^*_k B
\end{equation*}
\end{lemma}
\begin{lemma}
$\mathbb{E}^*_k$ is an endofunctor on the category of~$\sigma$-structures.
\end{lemma}
\begin{proof}
Preservation of identities is obvious. For composition we calculate:
\begin{eqproof*}
\mathbb{E}^*_k(k) \circ \mathbb{E}^*_k(h)(xs)
\explain{Definitions}
\mathbb{E}^*_k(k) \circ t^{h\epsilon(xs)} \circ s^\emptyset \circ L^+_k h (xs) 
\explain{Definitions}
t^{kh\epsilon(xs)} \circ s^\emptyset \circ L^+_k k \circ t^{h \epsilon(xs)} \circ s^\emptyset \circ L^+_k h (xs)
\explain{Lemma \ref{lem:t-s-commute}}
t^{kh\epsilon(xs)} \circ s^\emptyset \circ L^+_k k \circ s^\emptyset \circ t^{h \epsilon(xs)} \circ  L^+_k h (xs)
\explain{Lemma \ref{lem:s-idem}}
t^{kh\epsilon(xs)} \circ s^\emptyset \circ L^+_k k \circ t^{h \epsilon(xs)} \circ  L^+_k h (xs)
\explain{Lemma \ref{lem:t-s-commute}}
s^\emptyset \circ t^{kh\epsilon(xs)} \circ L^+_k k \circ t^{h \epsilon(xs)} \circ  L^+_k h (xs)
\explain{Lemma \ref{lem:t-idem}}
s^\emptyset \circ t^{kh\epsilon(xs)} \circ L^+_k k \circ  L^+_k h (xs)
\explain{Functoriality}
s^\emptyset \circ t^{kh\epsilon(xs)} \circ L^+_k (k \circ h) (xs)
\explain{Lemma \ref{lem:t-s-commute}}
t^{kh\epsilon(xs)} \circ s^\emptyset \circ L^+_k (k \circ h) (xs)
\explain{Definitions}
\mathbb{E}^*_k(k \circ h)(xs)
\end{eqproof*}
\end{proof}

\section{Most Recent Appearance Scheme}
This scheme only retains the most recent moves in a play, which is well motivated and straightforward to describe.
\begin{definition}
We define inductively a family of functions on lists over a set~$X$, indexed by a finite subsets of~$X$.
\begin{align*}
    n^X [] &= []\\
    n^X (xs:x) &= 
    \begin{cases}
    n^X xs &\mbox{ if } x \in X\\
    (n^{X \cup \{ x \} }xs) : x &\mbox{ otherwise}
    \end{cases}
\end{align*}
\end{definition}
\begin{lemma}
The function $n^X$ has the following properties:
\begin{itemize}
    \item $n^\emptyset$ preserves non-empty lists.
    \item $n^X$ does not contain any elements of~$X$.
    \item $n^\emptyset$ preserves the prefix order.
\end{itemize}
\end{lemma}

We define the structure for our proposed endofunctor.
\begin{definition}
For $\sigma$-structure~$A$, define~$\mathbb{E}^*_K$ as having:
\begin{description}
\item[Universe] The universe is the set of non-repeating, non-empty lists of elements from~$A$.
\item[Relations] For n-tuple $\overline{a}$ of elements, and n-ary relation symbol~$R$, we define:
\begin{equation*}
    R^{\mathbb{E}^*_k}(\overline{a})
\end{equation*}
if the elements of~$\overline{a}$ are pairwise comparable in the prefix order, and:
\begin{equation*}
    R^A(\epsilon(\overline{a}))
\end{equation*}
\end{description}
For homomorphism~$h : A \rightarrow B$ we define function:
\begin{equation*}
    \mathbb{E}^*_k(h) = n^\emptyset \circ L_k h
\end{equation*}
\end{definition}
So far, hopefully we have not done much more than try and formalize the proposed construction. Unfortunately we quickly hit a hurdle:
\begin{lemma}
For homomorphism~$h : A \rightarrow B$ function~$\mathbb{E}^*_k h$ is not necessarily a homomorphism of type:
\begin{equation*}
    \mathbb{E}^*_k A \rightarrow \mathbb{E}^*_k B
\end{equation*}
\end{lemma}
\begin{proof}
Let~$A$ and~$B$ have universes~$\{a,b,c\}$ and~$\{a,b\}$ such that:
\begin{equation*}
    R^A(b,c) \mbox{ and } R^B(b,a)
\end{equation*}
is the only relation. Then the mapping:
\begin{align*}
    h(a) &= a\\
    h(b) &= b\\
    h(c) &= a
\end{align*}
is a homomorphism. We have prefix relation:
\begin{equation*}
    [a,b] \leq [a,b,c]
\end{equation*}
and so:
\begin{equation*}
    R^{\mathbb{E}^*_k A}([a,b], [a,b,c])
\end{equation*}
We consider the action of~$\mathbb{E}^*_k h$ on these sequences. Firstly the element wise operation preserves prefix ordering:
\begin{equation*}
    L_k [a,b] = [a,b] \leq [a,b,a] = L_k h [a,b,c]
\end{equation*}
The second normalization step does not:
\begin{equation*}
    \mathbb{E}^*_k [a,b] = [a,b] \not\leq [b,a] = \mathbb{E}^*_k [a,b,c]
\end{equation*}
Therefore~$h$ is a homomorphism, but~$\mathbb{E}^*_k h$ is not as it does not preserve~$R$.
\end{proof}

\end{document}
